> [日本語版](README.ja.md)

# azure-blob-storage-site-deploy

[For developers](https://github.com/nuitsjp/azure-blob-storage-site-deploy-dev)

A GitHub Actions Composite Action for publishing content to the static website feature of Azure Blob Storage.

It aggregates sites from multiple repositories into a single storage account and simultaneously publishes multiple environments such as `main` and `develop`. Staging environments are automatically deployed when a PR is created, and automatically cleaned up when the PR is merged or closed.

This action focuses on publishing development documentation rather than production sites. It does not support SPAs (Single Page Applications) and is suited for publishing HTML generated by static site generators.

## Features

- **PR Staging** — Automatically created on PR open, automatically deleted on close. No limit on the number of environments
- **Clean Deploy** — All existing files are deleted before uploading, ensuring deletions and renames are reliably reflected
- **Multi-Environment** — Environments are isolated by prefix (e.g., `main/`, `develop/`, `pr-42/`) and published simultaneously
- **Multi-Repository** — Namespace isolation via `site_name` aggregates sites from multiple repositories into a single storage account
- **OIDC Authentication** — Secure authentication using Azure Entra ID federated credentials (no storage keys required)

## Prerequisites

- A storage account with the Azure Blob Storage static website feature enabled
- Configuration allowing GitHub Actions to connect via Azure OIDC authentication (Azure Entra ID app registration + federated credentials)
- "Storage Blob Data Contributor" role assignment on the storage account

## Limitations

SPAs (Single Page Applications) are not supported in the multi-environment configuration.

Azure Blob Storage static websites allow only a single error document for the entire storage account. With this action's design of separating multiple environments by prefix, per-site fallback cannot be achieved. HTML generated by SSGs (Static Site Generators) can be deployed without issues.

For hosting SPAs, we recommend using Azure Static Web Apps.

## Usage

Simply pass `branch_name` and `pull_request_number`, and the action will automatically resolve the prefix internally. No branching logic is needed on the caller's side.

```yaml
name: Deploy

on:
  push:
    branches: [main]
    paths:
      - "docs/**/*.md"
      - ".github/workflows/deploy.yml"
  pull_request:
    types: [opened, synchronize, reopened, closed]
    paths:
      - "docs/**/*.md"
      - ".github/workflows/deploy.yml"

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: nuitsjp/azure-blob-storage-site-deploy@v1
        id: deploy
        with:
          action: deploy
          storage_account: ${{ vars.AZURE_STORAGE_ACCOUNT }}
          source_dir: ./dist
          branch_name: ${{ github.head_ref || github.ref_name }}
          pull_request_number: ${{ github.event.pull_request.number }}

      # Output the deployment URL to the Workflow Summary
      - name: Output deployment URL to Workflow Summary
        if: success() && steps.deploy.outputs.site_url != ''
        run: |
          site_url="${{ steps.deploy.outputs.site_url }}"
          {
            echo "## Deployment URL"
            echo "- URL: [${site_url}](${site_url})"
          } >> "$GITHUB_STEP_SUMMARY"

  cleanup:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - uses: nuitsjp/azure-blob-storage-site-deploy@v1
        with:
          action: cleanup
          storage_account: ${{ vars.AZURE_STORAGE_ACCOUNT }}
          pull_request_number: ${{ github.event.pull_request.number }}
```

## Parameters

### Inputs

| Name | Required | Description |
|------|----------|-------------|
| `action` | **yes** | `deploy` (deploy) or `cleanup` (delete) |
| `storage_account` | **yes** | Azure Storage account name |
| `source_dir` | deploy only | Directory to upload |
| `site_name` | no | Site identifier. When omitted, automatically derived from the repository name in `GITHUB_REPOSITORY`. Specify this when deploying multiple repositories to the same storage account |
| `branch_name` | conditional | Branch name. Used as the prefix when `pull_request_number` is not specified |
| `pull_request_number` | conditional | PR number. When specified, `pr-<number>` is used as the prefix (takes priority over `branch_name`) |

> Either `branch_name` or `pull_request_number` is required, but as shown in the usage example, specifying both enables support for both branch pushes and pull requests.

### Outputs

| Name | Description |
|------|-------------|
| `site_url` | URL of the deployed site on successful deploy (with trailing slash). Example: `https://<account>.<zone>.web.core.windows.net/my-docs/pr-42/` |

## URL Structure

Deployed sites are placed under `<endpoint>/<site_name>/<prefix>/`. The prefix is automatically determined from `branch_name` or `pr-<pull_request_number>`.

```
https://<account>.<zone>.web.core.windows.net/
├── api-docs/              ← site_name: api-docs (Repository A)
│   ├── main/              ← branch_name: main
│   ├── develop/           ← branch_name: develop
│   └── pr-42/             ← pull_request_number: 42
└── user-guide/            ← site_name: user-guide (Repository B)
    ├── main/
    └── pr-10/
```

### Note

Azure Blob Storage static websites do not automatically redirect from `/<site_name>/<prefix>` to `/<site_name>/<prefix>/`. Always include a trailing slash in links. The `site_url` output automatically includes a trailing slash.

## Comparison with Azure Static Web Apps (SWA)

If you have access to Private Endpoints and want to restrict access at the network level, this action (Blob Storage approach) is a good fit.

On the other hand, if you need individual user authentication via Entra ID / GitHub, etc., we recommend using SWA.

Each approach has the following characteristics:

| Aspect | Blob Storage + This Action | SWA Free | SWA Standard |
|---|---|---|---|
| Repositories | Unlimited | 1 | 1 |
| Persistent environments (main, develop, etc.) | Unlimited | 1 | 1 |
| PR staging environments | Unlimited | Up to 3 | Up to 10 |
| Private Endpoint | Yes (requires 2: web + blob) | No | Yes *1 |
| Individual user authentication (Entra ID / GitHub, etc.) | Partially supported (requires combining with other services) | Yes (up to 25 users) | Yes *2 |
| SPA (React, Vue, etc.) | No *3 | Yes | Yes |
| Estimated monthly cost | Approx. $14.63 *4 | Free | Approx. $9.00 / $16.31 *5 |

Costs are approximate values converted at $1 = 160 JPY.

*1 Private Endpoints can be configured for the production environment. Preview environments use dynamically issued domains, so caution is required when applying them.

*2 The Standard plan supports invitation-based role management (up to 25 users) as well as unlimited role assignment via serverless functions. However, since preview environments use dynamically changing domains, caution is required when applying custom authentication.

*3 Azure Blob Storage static websites allow only a single error document for the entire storage account. With this action's design of separating multiple environments by prefix, per-site fallback cannot be achieved.

*4 This is the cost for Private Endpoints (web + blob, approx. $7.31 x 2). Additional storage and bandwidth costs may apply depending on usage.

*5 Approx. $9.00 is the Standard plan cost alone. When using Private Endpoints, approx. $7.31 is added.

When using SWA with individual user authentication, the following Action can automatically add GitHub users as SWA invited users:

- [ssd-mkdocs-platform/swa-github-role-sync](https://github.com/ssd-mkdocs-platform/swa-github-role-sync)

## License

[MIT](LICENSE)
